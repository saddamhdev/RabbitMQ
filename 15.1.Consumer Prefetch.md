**Consumer Prefetch** рж╣рж▓рзЛ RabbitMQ-ржПрж░ ржПржХржЯрж┐ ржЦрзБржм ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж╕рзЗржЯрж┐ржВ, ржпрж╛ ржарж┐ржХ ржХрж░рзЗ:

ЁЯСЙ **ржПржХржЬржи consumer ржПржХрж╕рж╛ржерзЗ queue ржерзЗржХрзЗ ржХрждржЧрзБрж▓рзЛ message ржирзЗржмрзЗ (buffer ржХрж░ржмрзЗ)**
ЁЯСЙ **ржкрж░ржмрж░рзНрждрзА message ржжрзЗржУрзЯрж╛рж░ ржЖржЧрзЗ ржХрждржЧрзБрж▓рзЛ ACK ржкрзНрж░рждрзНржпрж╛рж╢рж╛ ржХрж░ржмрзЗ**

ржПржЯрж╛ ржорзВрж▓ржд **QoS (Quality of Service)** ржПрж░ ржЕржВрж╢ред

ржЪрж▓рзЛ ржЦрзБржм рж╕рж╣ржЬржнрж╛ржмрзЗ ржмрзБржЭрж┐ ЁЯСЗ

---

# ЁЯЯж **Prefetch ржХрзА? (Simple Explanation)**

**Prefetch = ржПржХ consumer ржПржХрж╕рж╛ржерзЗ maximum ржХржд message hold ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗред
ACK ржирж╛ ржжрзЗржУрзЯрж╛ ржкрж░рзНржпржирзНржд RabbitMQ ржирждрзБржи message ржжрзЗржмрзЗ ржирж╛ред**

Example:

```
prefetch = 1  
тЖТ consumer ржПржХржмрж╛рж░рзЗ рж╢рзБржзрзБ 1 ржЯрж╛ message ржирзЗржмрзЗ  
тЖТ ржХрж╛ржЬ рж╢рзЗрж╖ рж╣рж▓рзЗ ACK ржжрзЗржмрзЗ  
тЖТ рждрж╛рж░ржкрж░ ржкрж░рзЗрж░ message ржкрж╛ржмрзЗ
```

Example:

```
prefetch = 10  
тЖТ consumer ржЖржЧрзЗржЗ 10ржЯрж╛ message ржирзЗржмрзЗ  
тЖТ ржПрж░ржкрж░ ACK ржирж╛ ржжрзЗржУрзЯрж╛ ржкрж░рзНржпржирзНржд ржЖрж░ message ржкрж╛ржмрзЗ ржирж╛
```

---

# ЁЯЯй ржХрзЗржи Prefetch ржжрж░ржХрж╛рж░?

Prefetch **slow consumer** тЖТ overload рж╣ржУрзЯрж╛ ржерзЗржХрзЗ protect ржХрж░рзЗред

Without Prefetch:

* consumer ржЕржирзЗржХ message ржПржХрж╕рж╛ржерзЗ ржкрзЗрзЯрзЗ ржпрж╛рзЯ
* memory high рж╣рзЯ
* slow рж╣рж▓рзЗ backlog huge рж╣рзЯ
* unfair load balancing рж╣рзЯ
* fast consumer ржХржо ржкрж╛рзЯ, slow consumer ржмрзЗрж╢рж┐ ржкрж╛рзЯ ЁЯШб

With Prefetch:

* ржкрзНрж░рждрж┐ consumer fair load ржкрж╛рзЯ
* slow consumer overload рж╣рзЯ ржирж╛
* message distribution balanced рж╣рзЯ
* ACK ржкрж░рзНржпржирзНржд queue block ржерж╛ржХрзЗ тЖТ backpressure рждрзИрж░рж┐ рж╣рзЯ

---

# ЁЯЯж Diagram

```
Queue тЖТ Consumer
       тЖС Prefetch limit controls flow
```

---

# ЁЯЯж Prefetch ржХрзЛржерж╛рзЯ ржмрзЗрж╢рж┐ ржмрзНржпржмрж╣рж╛рж░ рж╣рзЯ?

тЬФ Quiz scoring service
тЬФ Email/SMS sending worker
тЬФ Payment/transaction processing
тЬФ Long-running tasks
тЬФ Heavy CPU worker
тЬФ Microservice event processor

---

# ЁЯЯй Default Prefetch ржХржд?

RabbitMQ default:

```
prefetch = unlimited
```

ржорж╛ржирзЗ Consumer queue ржерзЗржХрзЗ ржпржд message ржЖрж╕рзЗ рж╕ржм ржирж┐рзЯрзЗ ржирзЗрзЯред

ржПржЯрж╛ ржЦрзБржмржЗ dangerous high-load systems ржПред

---

# ЁЯЯж Spring Boot-ржП Prefetch ржХрж┐ржнрж╛ржмрзЗ рж╕рзЗржЯ ржХрж░рзЛ?

## тЬФ SimpleRabbitListenerContainerFactory ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ

```java
@Bean
public SimpleRabbitListenerContainerFactory prefetchFactory(ConnectionFactory connectionFactory) {
    SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory);

    // Set prefetch
    factory.setPrefetchCount(1);

    return factory;
}
```

---

# тЬФ Listener ржП Prefetch bind ржХрж░рзЗ ржмрзНржпржмрж╣рж╛рж░

```java
@RabbitListener(queues = "task.queue", containerFactory = "prefetchFactory")
public void handleTask(String msg) {
    System.out.println("Processing: " + msg);
}
```

---

# ЁЯЯз Prefetch Best Practices

### 1я╕ПтГг CPU Heavy ржХрж╛ржЬ тЖТ prefetch = 1

```
Long scoring, PDF generating, ML processing
```

### 2я╕ПтГг Fast lightweight worker тЖТ prefetch = 10тАУ50

```
Simple DB insert, log processing
```

### 3я╕ПтГг Webhook / Notification system тЖТ prefetch = 5тАУ20

---

# ЁЯЯе Wrong Prefetch Example (Danger)

```
prefetch = unlimited
```

ржПржЗ рж╕ржорж╕рзНржпрж╛ ржХрж░ржмрзЗ:

тЭМ slow consumer рж╕ржм message ржирж┐рзЯрзЗ ржмрж╕рзЗ ржерж╛ржХржмрзЗ
тЭМ fast consumer idle ржЕржмрж╕рзНржерж╛рзЯ ржерж╛ржХржмрзЗ
тЭМ unfair distribution
тЭМ memory leak / OOM

---

# ЁЯЯж Practical Example (Quiz System)

5 consumers ржЖржЫрзЗ:

* Consumer-1 slow
* Consumer-2 fast
* Consumer-3 fast
* Consumer-4 slow
* Consumer-5 medium

If prefetch = unlimited:

```
slow consumer gets 1000 messages  
fast consumers get 10 messages only  
system bottleneck created  
```

If prefetch = 1:

```
fair distribution  
5 consumers тЖТ 5 parallel message  
scaling predictable  
no overload  
```

---

# ЁЯЯй One-line Summary

ЁЯСЙ **Prefetch = Consumer ржХржд message buffer ржХрж░ржмрзЗ рж╕рзЗржЗ limitред Slow consumer protect ржХрж░рзЗ ржПржмржВ fair load balancing ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗред**

---

# ржпржжрж┐ ржЪрж╛ржУ ЁЯФе

ржЖржорж┐ ржжрж┐рждрзЗ ржкрж╛рж░рж┐:

тЬФ Prefetch + Retry + DLQ + Backpressure full architecture
тЬФ Performance-optimized prefetch settings
тЬФ Different workloads ржЕржирзБржпрж╛рзЯрзА best prefetch value
тЬФ Prefetch visualization diagram

ржмрж▓рж▓рзЗржЗ ржХрж░рзЗ ржжрж┐ржЪрзНржЫрж┐!
